<!doctype html>
<html>
  <head>
    <title>Socket Example</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
	html, body {
	    height: 100%;
	    margin: 0;
	    padding: 0;
	}
	#map {
	    height: 100%;
	}
     </style>
  </head>
  <script src="/socket.io/socket.io.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
  <script>
	var socket = io();	

	var map;
	var beuthCoords = {lat: 52.545517, lng: 13.351622};
	var markers = [];

	function initMap() {
	        
	    map = new google.maps.Map(document.getElementById('map'), {
	    	center: beuthCoords, // der Beuth Hochschule
	        zoom: 15
	    });

	    var deleteObjectOnServer = function(object) {
		console.log('... sending delete:' + object)
		socket.emit('delete object', object);
	    }

	    var setDeleteListener = function(marker){		
		marker.addListener('click', function(event) {
		    deleteObjectOnServer(event.latLng);
		});
	    }		

	    var createNewMarker = function(map, coords) {
			var newMarker = new google.maps.Marker({
				position: coords,
				map: map,
			});

			markers.push(newMarker);
			setDeleteListener(newMarker);

			return newMarker;
	    }

	    var sendObjectToServer = function(object) {
			console.log('... sending coords:' + object)
			socket.emit('send object', object);
	    }	    

	    map.addListener('click', function(event) {
			// var newMarker = createNewMarker(map, event.latLng);
			sendObjectToServer(event.latLng);
	    });

	    socket.on('delete object', function(object) {
		for(var i = 0; i < markers.length; i++) {
		    if(object.lat === markers[i].position.lat() 
			&& object.lng === markers[i].position.lng()){

			markers[i].setMap(null);
			markers.splice(i, 1);

		    }
		}
	    });

	    socket.on('send object', function(object){
    		console.log('coords incoming: ' + object);
			createNewMarker(map, object)
  	    });

	    // create initial Beuth Marker
	    var beuthMarker = createNewMarker(map, beuthCoords);
	}

  </script>
  <body>
    <div id="map"></div>
  </body>
</html>
